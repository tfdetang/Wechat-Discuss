{% extends "mobile_header.html" %}

{% block body %}

    <style type="text/css">

        .avatar {
            width: 1.3rem;
        }

        .nickname {
            font-weight: bold;
        }

        .time {
            color: darkgray;
            font-size: 0.6rem;
        }

        .content-block {
            margin-top: 0.8rem;
        }

        .media-list {
            margin-left: 3rem;
            margin-right: 3rem;
            border: 1px solid #bbbbbb;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .item-link {
            background-color: rgba(239, 239, 244, 0.7);
        }

        .media-left {
            margin-left: -0.8rem;
        }

        .img-responsive {
            max-width: 100%;
            height: 5rem;
            padding: 0.1rem;
            padding-bottom: 30%;
            overflow: hidden;
            border-radius: 0.2rem;
        }

        .img-responsive-single {
            max-width: 100%;
            height: 0;
            padding-bottom: 80%;
            overflow: hidden;
            border-radius: 0.2rem;
        }

        .img-responsive img {
            width: 100%;
        }

        .img-responsive-single img {
            width: 100%;
        }

        .spliter {
            border: 0;
            height: 0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        #message_replies {
            font-size: 0.7rem;
            margin-left: 1rem;
        }

    </style>

    <script>

        String.prototype.format = function () {
            var args = arguments;
            return this.replace(/\{(\d+)\}/g, function (a, num) {
                return args[num] || a
            })
        };

        $.getJSON('/timeline/message_{{ messageid }}', {}, function (messages) {
            var id = messages.author_id;
            var message_id = messages.id;
            var nick_name = messages.nickname;
            var create_time = moment(messages.time_create).fromNow();
            var content = messages.body;
            var comment_count = messages.comment_count;
            var quote_count = messages.quote_count;
            var favo_count = messages.favo_count;
            var images = " ";
            var quoted = " ";

            if (messages.images.length > 0) {
                var img_count = messages.images.length;

                /*=== 默认为 standalone ===*/
                $(function () {
                    /*=== 默认为 standalone ===*/
                    var myPhotoBrowserStandalone = $.photoBrowser({
                        photos: messages.images
                    });
                    //点击时打开图片浏览器
                    $(document).on('click', '.pb-standalone', function () {
                        myPhotoBrowserStandalone.open();
                    });

                });

                if (img_count == 1) {
                    var width = " ";
                    var responsive = "img-responsive-single"
                } else if (img_count == 2) {
                    var width = "col-50";
                    var responsive = "img-responsive"
                } else if (img_count == 3) {
                    var width = "col-33";
                    var responsive = "img-responsive"
                } else {
                    var width = "col-50";
                    var responsive = "img-responsive"
                }
                for (var j = 0; j < img_count; j++) {
                    image_html = "<div class=\"{0} {1}\"><img src=\"" + messages.images[j] + "\"></div>";
                    images = images + image_html.format(width, responsive);
                }
                images = "<a href=\"#\" class=\"pb-standalone\"><div class=\"row no-gutter\">" + images + "</div></a><br>"
            }

            if (messages.quoted) {
                var quoted_id = messages.quoted.id;
                var quoted_body = messages.quoted.body;
                var quoted_author_id = messages.quoted.author_id;
                var quoted_nickname = messages.quoted.nickname;
                quoted_image = " ";
                if (messages.quoted.image) {
                    var image_url = messages.quoted.image;
                    quoted_image = "<div class=\"item-media media-left img-responsive\"><img src=\"{0}\" style='width: 5rem'></div>".format(image_url)
                }


                var quoted_html = "<br><div class=\"list-block media-list\">\n" +
                    "    <ul>\n" +
                    "      <li>\n" +
                    "        <a href=\"/mobile/message/id_{3}\" class=\"item-link external item-content\">\n" +
                    "          {0}<div class=\"item-inner\">\n" +
                    "            <div class=\"item-title-row\">\n" +
                    "              <div class=\"item-title\" style=\"font-size:0.6rem;color: darkgray;\">@{1}</div>\n" +
                    "            </div>\n" +
                    "            <div class=\"item-text\" style=\"font-size:0.6rem\">{2}</div>\n" +
                    "          </div>\n" +
                    "        </a>\n" +
                    "      </li>\n" +
                    "    </ul>\n" +
                    "  </div>";

                var quoted = quoted_html.format(quoted_image, quoted_nickname, quoted_body, quoted_id)
            }

            var raw = "<div class=\"facebook-card\">\n" +
                "    <div class=\"card-header no-border\">\n" +
                "      <div class=\"facebook-avatar\"><img src=\"http://{{ baseurl }}/avatar_{0}\" width=\"35\" height=\"35\"></div>\n" +
                "      <div class=\"facebook-name nickname\">{1} <br><span class='time'>{2}</span></div>\n" +
                "    </div>\n" +
                "    <div class=\"card-content\">" +
                "       <div class=\"card-content-inner\">" +
                "      <div class=\"item-media\">{4}</div><div class=\"item-inner\">{5}</div>{6}" +
                "</div></div>\n" +
                "  </div>" +
                "<hr class=\"spliter\">\n" +
                "<div class=\"row\">\n" +
                "    <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-heart-o\" aria-hidden=\"true\"></i> {7}</a>\n" +
                "    <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-comments-o\" aria-hidden=\"true\"></i> {8}</a>\n" +
                "    <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-retweet\" aria-hidden=\"true\"></i> {9}</a>\n" +
                "    <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-envelope-o\" aria-hidden=\"true\"></i></a>\n" +
                "</div>\n" +
                "<hr class=\"spliter\">";
            raw = raw.format(id, nick_name, create_time, message_id, images, content, quoted, favo_count, comment_count, quote_count);
            var html = $(raw);

            $("#message_detail").append(html);

        });

        $.getJSON('/timeline/message_{{ messageid }}/get_replies', {
            'start': '0'
        }, function (replies) {
            if (replies.count > 0) {
                for (var i = 0; i < replies.replies.length; i++) {
                    var id = replies.replies[i].author_id;
                    var message_id = replies.replies[i].id;
                    var nick_name = replies.replies[i].nickname;
                    var create_time = moment(replies.replies[i].time_create).fromNow();
                    var content = replies.replies[i].body;
                    var comment_count = replies.replies[i].comment_count;
                    var quote_count = replies.replies[i].quote_count;
                    var favo_count = replies.replies[i].favo_count;

                    var raw = "<div class=\"row\"><div class=\"col-12\"><img src=\"http://{{ baseurl }}/avatar_{0}\" width=\"40\" height=\"40\"></div>\n" +
                        "<div class=\"col-85\">\n" +
                        "     <div class=\"nickname\">{1} <span class=\"time\">{2}</span></div>\n" +
                        "          <div>{3}</div><br>\n" +
                        "          <div class=\"row\" style=\"text-align: left;\">\n" +
                        "               <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-heart-o\" aria-hidden=\"true\"></i></a>\n" +
                        "               <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-comments-o\" aria-hidden=\"true\"></i></a>\n" +
                        "               <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-retweet\" aria-hidden=\"true\"></i></a>\n" +
                        "               <a href=\"#\" class=\"link col-25\"><i class=\"fa fa-envelope-o\" aria-hidden=\"true\"></i></a>\n" +
                        "           </div>\n" +
                        "       <hr class=\"spliter\">\n" +
                        " </div></div>";
                    raw = raw.format(id, nick_name, create_time, content);
                    var html = $(raw);

                    $("#message_replies").append(html);
                }
            }
        });

        $.init()

    </script>

    <div class="page-group">
        <!-- 单个page ,第一个.page默认被展示-->
        <div class="page" id="home">
            <!-- 标题栏 -->
            <header class="bar bar-nav" id="head-nav">
                <a class="icon icon-left pull-left external" data-no-cache="true" href="javascript:history.go(-1)"></a>
                <h2 class="title">推文</h2>

            </header>

            <!-- 这里是页面内容区 -->
            <div class="content">
                <div class="content-block">

                    <div class="body" id="message_detail">

                    </div>


                    <div id="message_replies">


                    </div>

                </div>
            </div>
        </div>
    </div>


{% endblock %}